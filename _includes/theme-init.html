<script>
  class Theme {
    static get #modeKey() { return 'mode'; }
    static get #modeAttr() { return 'data-mode'; }
    static get #darkMedia() { return window.matchMedia('(prefers-color-scheme: dark)'); }
    
    static get DARK() { return 'dark'; }
    static get LIGHT() { return 'light'; }
    static get ID() { return 'theme-mode'; }

    static get #mode() {
      return sessionStorage.getItem(this.#modeKey) ||
        document.documentElement.getAttribute(this.#modeAttr);
    }

    static get visualState() {
      return this.#mode || (this.#darkMedia.matches ? this.DARK : this.LIGHT);
    }

    static #setDark() {
      document.documentElement.setAttribute(this.#modeAttr, this.DARK);
      sessionStorage.setItem(this.#modeKey, this.DARK);
      document.documentElement.classList.add('dark');
      document.documentElement.classList.remove('light');
    }

    static #setLight() {
      document.documentElement.setAttribute(this.#modeAttr, this.LIGHT);
      sessionStorage.setItem(this.#modeKey, this.LIGHT);
      document.documentElement.classList.add('light');
      document.documentElement.classList.remove('dark');
    }

    static flip() {
      const isDark = this.visualState === this.DARK;
      isDark ? this.#setLight() : this.#setDark();
      window.dispatchEvent(new CustomEvent(this.ID));
    }

    static init() {
      const isDark = this.visualState === this.DARK;
      isDark ? this.#setDark() : this.#setLight();
    }
  }

  // Initialize theme immediately to prevent flash
  Theme.init();

  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('mode-toggle');
    if (!toggle) return;

    const updateState = () => {
      const isDark = Theme.visualState === Theme.DARK;
      toggle.setAttribute('aria-checked', isDark ? 'true' : 'false');
    };

    toggle.addEventListener('click', () => {
      Theme.flip();
      updateState();
    });

    window.addEventListener(Theme.ID, updateState);
    updateState();
  });
</script>
